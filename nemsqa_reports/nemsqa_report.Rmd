---
title: "D.C. Fire and EMS NEMSQA Key Performance Indicator Report"
author: "Office of the Medical Director - CQI Division"
date: '`r Sys.Date()`'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Libraries
library(tidyverse)
library(lubridate)
library(janitor)
library(splitstackshape)
library(ggthemes)
library(kableExtra)
library(scales)
library(qicharts2)
library(extrafont)

```


```{r functions, echo=FALSE, include=FALSE}

StatMedianLine <- ggproto("StatMedianLine", Stat,
                          compute_group = function(data, scales) {
                            transform(data, yintercept=median(y))
                          },
                          required_aes = c("x", "y")
)

stat_median_line <- function(mapping = NULL, data = NULL, geom = "hline",
                             position = "identity", na.rm = FALSE, show.legend = NA, 
                             inherit.aes = TRUE, ...) {
  layer(
    stat = StatMedianLine, data = data, mapping = mapping, geom = geom, 
    position = position, show.legend = show.legend, inherit.aes = inherit.aes,
    params = list(na.rm = na.rm, ...)
  )
}

```


```{r report notes, include=FALSE, echo=FALSE}
# This report is an analysis of NEMSQA KPI data generated by FirstWatch. The purpose of the report is to create a standard format to display and discuss data, and identify any changes and improvements in our KPIs. The primary tool for analysis will be the run chart, using quarterly, monthly, and weekly data points.

# Each measure will examine counts and percents, and will primarily be displayed in run charts. Control charts may be added in the future, but training/education for the intended audience will be necessary before adding. 


## INTENDED AUDIENCE ##
#
# The intended audience for this report will be Executive Team, EMS Battalion Chiefs and Supervisors. 


```




```{r data processing, include=FALSE}

setwd("P:/Analysis_R/Projects/nemsqa_reports/data")


# hypoglycemia

hypo_01_list <- list.files(pattern = "hypo_01")

df_hypo_01 <- hypo_01_list %>% map_dfr(read_csv)


# peds

peds_01_list <- list.files(pattern = "peds_01")

df_peds_01 <- peds_01_list %>% map_dfr(read_csv)


peds_02_list <- list.files(pattern = "peds_02")

df_peds_02 <- peds_02_list %>% map_dfr(read_csv)


peds_03_list <- list.files(pattern = "peds_03")

df_peds_03 <- peds_03_list %>% map_dfr(read_csv)


# safety

# seizure

seiz_02_list <- list.files(pattern = "seizure_02")

df_seiz_02 <- seiz_02_list %>% map_dfr(read_csv)


# stroke

stroke_01_list <- list.files(pattern = "stroke_01")

df_stroke_01 <- stroke_01_list %>% map_dfr(read_csv)


# trauma

trauma_01_list <- list.files(pattern = "trauma_01")

df_trauma_01 <- trauma_01_list %>% map_dfr(read_csv)


trauma_03_list <- list.files(pattern = "trauma_03")

df_trauma_03 <- trauma_03_list %>% map_dfr(read_csv)


trauma_04_list <- list.files(pattern = "trauma_04")

df_trauma_04 <- trauma_04_list %>% map_dfr(read_csv)

# 
# df_trauma_03 %>% 
#   count(`Problem`, `Trauma-03: Effective Pain Management`) %>% 
#   mutate(prop = n/sum(n)) %>% 
#   arrange(desc(n))




```


# Introduction

# How to use this report

This report utilizes statistical process control charts, specifically the use of *run charts*. A run chart is a specific type of graph used to understand how a process or system is operating. Each data point can be thought of as an output or outcome of system and is generally plotted over time. Because all systems and processes have variation in them, we can then generally expect the next data point to be different from the previous one. Thus, we begin to see and understand how outputs and outcomes vary. See Appendix for in-depth explanation on statistical process control charts.

With that in mind, each NEMSQA Measure has four charts associated with it - two charts represent count data, one monthly and other is weekly, with the weekly graph representing a rolling 27-week period. These represent the denominators for each measure.

The other two graphs are percent of reports that meet the standard, again monthly and a rolling 27-week period. The purpose is of aggregating and displaying data in this manner is to help smooth out large swings in the data, especially with small denominators.

Lastly, there may be times where changes are made to the system either through protocol or policy changes, or targeted improvement projects. When these changes occur, we consider them changes to the system and take that into consideration to determine the impact, if any, there is the measures. 



# National EMS Quality Alliance Measures

## Hypoglycemia

Definition:

Numerator:

Denominator:

Rationale:

Hypoglycemic emergencies are one of the few types of cases EMS has a demonstrable positive impact on the outcome of a patient. Furthermore, because hypoglycemic emergencies can mimic other etiologies (i.e., intoxication, seizure) it is imperative EMS use good judgement and assessment skills to draw upon in order to make a sound clinical decision - namely, assessing blood glucose with a glucometer for all patients with an altered level of consciousness.

While there are likely many cases where it is known prior to arriving on scene a crew is responding for a diabetic emergency, there are instances where this is the case - and good clinical judgement is vital.

### Hypoglycemia-01

```{r hypoglycemia 01 data, include=FALSE}

# Cleaning
df_hypo_01_cln <- 
  df_hypo_01 %>% 
  clean_names() %>% 
  distinct(incident_number, age, .keep_all = T) %>% 
  mutate_at(.vars = vars(time_dispatched, enroute:cleared),
            .funs = mdy_hms) %>% 
  mutate_if(is.character, toupper) %>% 
  select(-c(gc, geo_valid)) %>% 
  rename(hypo_01_tx_admin = hypoglycemia01_treatment_administered) %>% 
  mutate(hypo_01_tx_admin = as.numeric(case_when(hypo_01_tx_admin == "YES" ~ "1",
                                      TRUE ~ "0")))
# Table for Quarterly Results


# Graphs

## Run Charts

# Run Chart Tables:
run_chart_table_mnth <- 
  df_hypo_01_cln %>% 
  group_by(mnth = as.Date(cut(time_dispatched, '1 month'))) %>% 
  summarise(n = n(),
            treatment = sum(hypo_01_tx_admin)) %>% 
  ungroup() %>% 
  mutate(notes = "")


run_chart_table_week <- 
  df_hypo_01_cln %>% 
  group_by(wk = as.Date(cut(time_dispatched, '1 week'))) %>% 
  summarise(n = n(),
            treatment = sum(hypo_01_tx_admin)) %>% 
  ungroup() %>% 
  mutate(notes = "notes") %>% 
  tail(27)


# Run Charts: Counts
run_chart_hypo_01_mnth_n <- 
  qic(x = mnth,
      y = n,
      data = run_chart_table_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = (min(run_chart_table_mnth$n) - 10),
      title = "Run Chart: Patients with Hypoglycemia per Month",
      subtitle = "Fiscal Year: 2022",
      ylab  = "Patient Count",
      xlab  = NULL)+
  theme_tufte() +
  theme(legend.position = "none")

run_chart_hypo_01_wk_n <- 
  qic(x = wk,
      y = n,
      data = run_chart_table_week,
      chart = "run",
      point.size = 2.5,
      y.expand = 0,
      x.format = "%b '%y",
      title = "Run Chart: Patients with Hypoglycemia per Week",
      subtitle = "Fiscal Year: 2022",
      ylab  = "Patient Count",
      xlab  = NULL) +
  theme_tufte() +
  theme(legend.position = "none")



# Run Charts: Proportions
run_chart_hypo_01_mnth_p <- 
  qic(x = mnth,
      y = treatment,
      n = n,
      data = run_chart_table_mnth,
      chart = "run",
      point.size = 2.5,
      y.expand = c(.5, 1),
      y.percent = T,
      title = "Run Chart: Percent of Hypoglycemia Patients Treated per Month",
      subtitle = "Fiscal Year: 2022",
      ylab     = "Percent Treated",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')

run_chart_hypo_01_wk_p <- 
  qic(x = wk,
      y = treatment,
      n = n,
      data = run_chart_table_week,
      chart = "run",
      point.size = 2.5,
      y.expand = 0,
      y.percent = T,
      title = "Run Chart: Percent of Hypoglycemia Patients Treated per Week",
      subtitle = "Fiscal Year: 2022",
      ylab     = "Percent Treated",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')

```

```{r hypo 01 run chart count month, echo=FALSE, fig.width=10}
run_chart_hypo_01_mnth_n
```


```{r hypo 01 run chart count week, echo=FALSE, fig.width=10}
run_chart_hypo_01_wk_n
```


```{r hypo 01 run chart percent month, echo=FALSE, fig.width=10}
run_chart_hypo_01_mnth_p
```



```{r hypo 01 run chart percent week, echo=FALSE, fig.width=10}
run_chart_hypo_01_wk_p
```


Discussion:

## Pediatrics

### Peds-01

```{r pediatrics 01, include=FALSE}

# Data Cleaning
df_peds_01_cln <- 
  df_peds_01 %>% 
  clean_names() %>%
  distinct(incident_number, age, .keep_all = T) %>% 
  mutate_at(.vars = vars(time_dispatched, enroute:cleared),
            .funs = mdy_hms) %>% 
  mutate_if(is.character, toupper) %>% 
  select(-c(gc, geo_valid)) %>% 
  rename(peds_01_resp_assess = peds01_resp_assessment) %>% 
  mutate(peds_01_resp_assess = as.numeric(case_when(peds_01_resp_assess == "YES" ~ "1",
                                                    TRUE ~ "0")))


# Tables (Month and Week)
run_chart_table_peds_01_mnth <- 
  df_peds_01_cln %>% 
  group_by(mnth = as.Date(cut(time_dispatched, '1 month'))) %>% 
  summarise(n         = n(),
            treatment = sum(peds_01_resp_assess)) %>% 
  ungroup() %>% 
  mutate(notes = "")



run_chart_table_peds_01_wk <- 
  df_peds_01_cln %>% 
  group_by(wk = as.Date(cut(time_dispatched, '1 week'))) %>% 
  summarise(n         = n(),
            treatment = sum(peds_01_resp_assess)) %>% 
  ungroup() %>% 
  mutate(notes = "") %>% 
  tail(27)

# Run Charts: Counts
run_chart_peds_01_mnth_n <- 
  qic(x = mnth,
      y = n,
      data = run_chart_table_peds_01_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = (min(run_chart_table_peds_01_mnth$n)-10),
      title = "Run Chart: Count of Pediatric Respiratory Pts. per Month",
      subtitle = "Fiscal Year: 2022",
      ylab     = "Patient Count",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


run_chart_peds_01_wk_n <- 
  qic(x = wk,
      y = n,
      data = run_chart_table_peds_01_wk,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = 0,
      title = "Run chart: Count of Pediatric Respiratory Pts. per Week",
      subtitle = "Fiscal Year: 2022",
      ylab = "Patient Count",
      xlab = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')



# Run Charts: Proportions
run_chart_peds_01_mnth_p <- 
  qic(x = mnth,
      y = treatment,
      n = n,
      data = run_chart_table_peds_01_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.percent = T,
      y.expand = c(.5, 1),
      title = "Run Chart: % of Pediatric Respiratory Pts. with Documented Respiratory Assessment per Month",
      subtitle = "Fiscal Year: 2022",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


run_chart_peds_01_wk_p <- 
  qic(x = wk,
      y = treatment,
      n = n,
      data = run_chart_table_peds_01_wk,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.percent = T,
      y.expand = 0,
      title = "Run Chart: % of Pediatric Respiratory Pts. with Documented Respiratory Assessment per Week",
      subtitle = "Fiscal Year: 2022",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')




```


### Peds-02

```{r pediatrics 02, include=FALSE}
# Data Cleaning
df_peds_02_cln <- 
  df_peds_02 %>% 
  clean_names() %>%
  distinct(incident_number, age, .keep_all = T) %>% 
  mutate_at(.vars = vars(time_dispatched, enroute:cleared),
            .funs = mdy_hms) %>% 
  mutate_if(is.character, toupper) %>% 
  select(-c(gc, geo_valid)) %>% 
  rename(peds_02_beta_ag_admin = peds02_beta_agonist_admin) %>% 
  mutate(peds_02_beta_ag_admin = as.numeric(case_when(peds_02_beta_ag_admin == "YES" ~ "1",
                                                    TRUE ~ "0")))


# Tables (Month and Week)
run_chart_table_peds_02_mnth <- 
  df_peds_02_cln %>% 
  group_by(mnth = as.Date(cut(time_dispatched, '1 month'))) %>% 
  summarise(n         = n(),
            treatment = sum(peds_02_beta_ag_admin)) %>% 
  ungroup() %>% 
  mutate(notes = "")



run_chart_table_peds_02_wk <- 
  df_peds_02_cln %>% 
  group_by(wk = as.Date(cut(time_dispatched, '1 week'))) %>% 
  summarise(n         = n(),
            treatment = sum(peds_02_beta_ag_admin)) %>% 
  ungroup() %>% 
  mutate(notes = "") %>% 
  tail(27)

# Run Charts: Counts
run_chart_peds_02_mnth_n <- 
  qic(x = mnth,
      y = n,
      data = run_chart_table_peds_02_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = (min(run_chart_table_peds_02_mnth$n)-10),
      title = "Run Chart: Count of Pediatric Respiratory Pts. with Indicated Treatment with Beta Agonist per Month",
      subtitle = "Fiscal Year: 2022",
      ylab     = "Patient Count",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


run_chart_peds_02_wk_n <- 
  qic(x = wk,
      y = n,
      data = run_chart_table_peds_02_wk,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = 0,
      title = "Run chart:  Count of Pediatric Respiratory Pts. with Indicated Treatment with Beta Agonist per Week",
      subtitle = "Fiscal Year: 2022",
      ylab = "Patient Count",
      xlab = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')



# Run Charts: Proportions
run_chart_peds_02_mnth_p <- 
  qic(x = mnth,
      y = treatment,
      n = n,
      data = run_chart_table_peds_02_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.percent = T,
      y.expand = c(.4, 1),
      title = "Run Chart: % of Pediatric Respiratory Pts. with Indicated Treatment with Beta Agonist per Month",
      subtitle = "Fiscal Year: 2022",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


run_chart_peds_02_wk_p <- 
  qic(x = wk,
      y = treatment,
      n = n,
      data = run_chart_table_peds_02_wk,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.percent = T,
      y.expand = 0,
      title = "Run Chart: % of Pediatric Respiratory Pts. with Indicated Treatment with Beta Agonist per Week",
      subtitle = "Fiscal Year: 2022",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')

```


### Peds-03

```{r pediatrics 03, include=FALSE}
# Data Cleaning
df_peds_03_cln <- 
  df_peds_03 %>% 
  clean_names() %>%
  distinct(incident_number, age, .keep_all = T) %>% 
  mutate_at(.vars = vars(time_dispatched, enroute:cleared),
            .funs = mdy_hms) %>% 
  mutate_if(is.character, toupper) %>% 
  select(-c(gc, geo_valid)) %>% 
  rename(peds_03_wt_doc = peds03_weight_documented) %>% 
  mutate(peds_03_wt_doc = as.numeric(case_when(peds_03_wt_doc == "YES" ~ "1",
                                                    TRUE ~ "0")))


# Tables (Month and Week)
run_chart_table_peds_03_mnth <- 
  df_peds_03_cln %>% 
  group_by(mnth = as.Date(cut(time_dispatched, '1 month'))) %>% 
  summarise(n         = n(),
            treatment = sum(peds_03_wt_doc)) %>% 
  ungroup() %>% 
  mutate(notes = "")



run_chart_table_peds_03_wk <- 
  df_peds_03_cln %>% 
  group_by(wk = as.Date(cut(time_dispatched, '1 week'))) %>% 
  summarise(n         = n(),
            treatment = sum(peds_03_wt_doc)) %>% 
  ungroup() %>% 
  mutate(notes = "") %>% 
  tail(27)

# Run Charts: Counts
run_chart_peds_03_mnth_n <- 
  qic(x = mnth,
      y = n,
      data = run_chart_table_peds_03_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = (min(run_chart_table_peds_02_mnth$n)-10),
      title = "Run Chart: Count of Pediatric Patients With Documented Weight per Month",
      subtitle = "Fiscal Year: 2022",
      ylab     = "Patient Count",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


run_chart_peds_03_wk_n <- 
  qic(x = wk,
      y = n,
      data = run_chart_table_peds_03_wk,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = 0,
      title = "Run chart:  Count of Pediatric Patients with Documented Weight per Week",
      subtitle = "Fiscal Year: 2022",
      ylab = "Patient Count",
      xlab = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')



# Run Charts: Proportions
run_chart_peds_03_mnth_p <- 
  qic(x = mnth,
      y = treatment,
      n = n,
      data = run_chart_table_peds_03_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.percent = T,
      y.expand = c(.4, 1),
      title = "Run Chart: % of Pediatric Patients With Documented Weight per Month",
      subtitle = "Fiscal Year: 2022",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


run_chart_peds_03_wk_p <- 
  qic(x = wk,
      y = treatment,
      n = n,
      data = run_chart_table_peds_03_wk,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.percent = T,
      y.expand = 0,
      title = "Run Chart: % of Pediatric With Documented Weight per Week",
      subtitle = "Fiscal Year: 2022",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')
```


## Seizure

### Seizure-01

```{r seizure 01, include=FALSE}
# Data Cleaning
df_seiz_02_cln <- 
  df_seiz_02 %>% 
  clean_names() %>%
  distinct(incident_number, age, .keep_all = T) %>% 
  mutate_at(.vars = vars(time_dispatched, enroute:cleared),
            .funs = mdy_hms) %>% 
  mutate_if(is.character, toupper) %>% 
  select(-c(gc, geo_valid)) %>% 
  rename(seiz_02_treatment = seizure02_received_intervention) %>% 
  mutate(seiz_02_treatment = as.numeric(case_when(seiz_02_treatment == "YES" ~ "1",
                                                    TRUE ~ "0")))



# Tables (Month and Week)
run_chart_table_seiz_02_mnth <- 
  df_seiz_02_cln %>% 
  group_by(mnth = as.Date(cut(time_dispatched, '1 month'))) %>% 
  summarise(n         = n(),
            treatment = sum(seiz_02_treatment)) %>% 
  ungroup() %>% 
  mutate(notes = "")



run_chart_table_seiz_02_wk <- 
  df_seiz_02_cln %>% 
  group_by(wk = as.Date(cut(time_dispatched, '1 week'))) %>% 
  summarise(n         = n(),
            treatment = sum(seiz_02_treatment)) %>% 
  ungroup() %>% 
  mutate(notes = "") %>% 
  tail(27)


# Run Charts: Counts
run_chart_seiz_02_mnth_n <- 
  qic(x = mnth,
      y = n,
      data = run_chart_table_seiz_02_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = (min(run_chart_table_peds_02_mnth$n)-10),
      title = "Run Chart: Count of Patients With Seizures per Month",
      subtitle = "Fiscal Year: 2022",
      ylab     = "Patient Count",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


run_chart_seiz_02_wk_n <- 
  qic(x = wk,
      y = n,
      data = run_chart_table_seiz_02_wk,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = 0,
      title = "Run chart:  Count of Patients With Seizures per Week",
      subtitle = "Fiscal Year: 2022",
      ylab = "Patient Count",
      xlab = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')



# Run Charts: Proportions
run_chart_seiz_02_mnth_p <- 
  qic(x = mnth,
      y = treatment,
      n = n,
      data = run_chart_table_seiz_02_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.percent = T,
      y.expand = c(0, .75),
      title = "Run Chart: % of Patients with Documnted Seizures Treated with a Benzodiazipine per Month",
      subtitle = "Fiscal Year: 2022",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


run_chart_seiz_02_wk_p <- 
  qic(x = wk,
      y = treatment,
      n = n,
      data = run_chart_table_seiz_02_wk,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.percent = T,
      y.expand = c(0,1),
      title = "Run Chart: % of Patients with Documnted Seizures Treated with a Benzodiazipine per Week",
      subtitle = "Fiscal Year: 2022",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')

```


## Stroke

### Stroke-01

```{r stroke 01, include=FALSE}

```


## Trauma

### Trauma-01

```{r trauma 01, include=FALSE}

# Data Cleaning
df_trma_01_cln <- 
  df_trauma_01 %>% 
  clean_names() %>%
  distinct(incident_number, age, .keep_all = T) %>% 
  mutate_at(.vars = vars(time_dispatched, enroute:cleared),
            .funs = mdy_hms) %>% 
  mutate_if(is.character, toupper) %>% 
  select(-c(gc, geo_valid)) 



# Tables (Month and Week)
run_chart_table_trma_01_mnth <- 
  df_trma_01_cln %>% 
  group_by(mnth = as.Date(cut(time_dispatched, '1 month'))) %>% 
  summarise(n         = n(),
            treatment = sum(pain_assessed)) %>% 
  ungroup() %>% 
  mutate(notes = "")

run_chart_table_trma_01_mnth$notes[8] <- "Plt. 4 Project"

run_chart_table_trma_01_wk <- 
  df_trma_01_cln %>% 
  group_by(wk = as.Date(cut(time_dispatched, '1 week'))) %>% 
  summarise(n         = n(),
            treatment = sum(pain_assessed)) %>% 
  ungroup() %>% 
  mutate(notes = "") %>% 
  tail(27)

run_chart_table_trma_01_wk$notes[run_chart_table_trma_01_wk$wk == "2022-05-30"] <- "Plt. 4 Project"

# Run Charts: Counts
run_chart_trma_01_mnth_n <- 
  qic(x = mnth,
      y = n,
      data = run_chart_table_trma_01_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = c(500, 1200),
      title = "Run Chart: Count of Trauma Patients with Documented Pain Assessment per Month",
      subtitle = "Fiscal Year: 2022",
      ylab     = "Patient Count",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


run_chart_trma_01_wk_n <- 
  qic(x = wk,
      y = n,
      data = run_chart_table_trma_01_wk,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = 0,
      title = "Run chart: Count of Trauma Patients with Documented Pain Assessmentper Week",
      subtitle = "Fiscal Year: 2022",
      ylab = "Patient Count",
      xlab = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')



# Run Charts: Proportions
run_chart_trma_01_mnth_p <- 
  qic(x = mnth,
      y = treatment,
      n = n,
      notes = notes,
      data = run_chart_table_trma_01_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.percent = T,
      y.expand = c(0, .55),
      title = "Run Chart: % of Trauma Patients with Documnted Pain Assessment per Month",
      subtitle = "Fiscal Year: 2022",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


run_chart_trma_01_wk_p <- 
  qic(x = wk,
      y = treatment,
      n = n,
      notes = notes,
      data = run_chart_table_trma_01_wk,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.percent = T,
      y.expand = c(0,.5),
      title = "Run Chart:% of Trauma Patients with Documnted Pain Assessment per Week",
      subtitle = "Fiscal Year: 2022",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')



```


### Trauma-03

```{r trauma 03, include=FALSE}
# Data Cleaning
df_trma_03_cln <- 
  df_trauma_03 %>% 
  clean_names() %>%
  distinct(incident_number, age, .keep_all = T) %>% 
  mutate_at(.vars = vars(time_dispatched, enroute:cleared),
            .funs = mdy_hms) %>% 
  mutate_if(is.character, toupper) %>% 
  select(-c(gc, geo_valid)) %>% 
  rename(pain_managed = trauma_03_effective_pain_management) %>% 
  mutate(pain_managed = as.numeric(case_when(pain_managed == "YES" ~ "1",
                                             TRUE ~ "0")))



# Tables (Month and Week)
run_chart_table_trma_03_mnth <- 
  df_trma_03_cln %>% 
  group_by(mnth = as.Date(cut(time_dispatched, '1 month'))) %>% 
  summarise(n         = n(),
            treatment = sum(pain_managed)) %>% 
  ungroup() %>% 
  mutate(notes = "")

run_chart_table_trma_03_wk <- 
  df_trma_03_cln %>% 
  group_by(wk = as.Date(cut(time_dispatched, '1 week'))) %>% 
  summarise(n         = n(),
            treatment = sum(pain_managed)) %>% 
  ungroup() %>% 
  mutate(notes = "") %>% 
  tail(27)

# Run Charts: Counts
run_chart_trma_03_mnth_n <- 
  qic(x = mnth,
      y = n,
      data = run_chart_table_trma_03_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = 120,
      title = "Run Chart: Count of Injured Patients With Documented Pre- and Post-Pain Score per Month",
      subtitle = "Fiscal Year: 2022",
      ylab     = "Patient Count",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


run_chart_trma_03_wk_n <- 
  qic(x = wk,
      y = n,
      data = run_chart_table_trma_03_wk,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = 0,
      title = "Run Chart: Count of Injured Patients With Documented Pre- and Post-Pain Score per Week",
      subtitle = "Fiscal Year: 2022",
      ylab = "Patient Count",
      xlab = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')



# Run Charts: Proportions
run_chart_trma_03_mnth_p <- 
  qic(x = mnth,
      y = treatment,
      n = n,
      notes = notes,
      data = run_chart_table_trma_03_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.percent = T,
      y.expand = c(0, .55),
      title = "Run Chart: % of Injured Patients with Effective Pain Management per Month",
      subtitle = "Fiscal Year: 2022",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


run_chart_trma_03_wk_p <- 
  qic(x = wk,
      y = treatment,
      n = n,
      notes = notes,
      data = run_chart_table_trma_03_wk,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.percent = T,
      y.expand = c(0, 0.5),
      title = "Run Chart: % of Injured Patients with Effective Pain Management per Week",
      subtitle = "Fiscal Year: 2022",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')




```

### Trauma-04

```{r trauma 04, include=FALSE}

# Data Cleaning
df_trma_04_cln <- 
  df_trauma_04 %>% 
  clean_names() %>%
  distinct(incident_number, age, .keep_all = T) %>% 
  mutate_at(.vars = vars(time_dispatched, enroute:cleared),
            .funs = mdy_hms) %>% 
  mutate_if(is.character, toupper) %>% 
  select(-c(gc, geo_valid)) %>% 
  rename(trma_ctr = trauma_04_transported_to_trauma_center) %>% 
  mutate(trma_ctr = as.numeric(case_when(trma_ctr == "YES" ~ "1",
                                             TRUE ~ "0")))



# Tables (Month and Week)
run_chart_table_trma_04_mnth <- 
  df_trma_04_cln %>% 
  group_by(mnth = as.Date(cut(time_dispatched, '1 month'))) %>% 
  summarise(n         = n(),
            treatment = sum(trma_ctr)) %>% 
  ungroup() %>% 
  mutate(notes = "")

run_chart_table_trma_04_wk <- 
  df_trma_04_cln %>% 
  group_by(wk = as.Date(cut(time_dispatched, '1 week'))) %>% 
  summarise(n         = n(),
            treatment = sum(trma_ctr)) %>% 
  ungroup() %>% 
  mutate(notes = "") %>% 
  tail(27)

# Run Charts: Counts
run_chart_trma_04_mnth_n <- 
  qic(x = mnth,
      y = n,
      data = run_chart_table_trma_04_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = 120,
      title = "Run Chart: Count of Injured Patients With Documented Pre- and Post-Pain Score per Month",
      subtitle = "Fiscal Year: 2022",
      ylab     = "Patient Count",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


run_chart_trma_03_wk_n <- 
  qic(x = wk,
      y = n,
      data = run_chart_table_trma_03_wk,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.expand = 0,
      title = "Run Chart: Count of Injured Patients With Documented Pre- and Post-Pain Score per Week",
      subtitle = "Fiscal Year: 2022",
      ylab = "Patient Count",
      xlab = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')



# Run Charts: Proportions
run_chart_trma_03_mnth_p <- 
  qic(x = mnth,
      y = treatment,
      n = n,
      notes = notes,
      data = run_chart_table_trma_03_mnth,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.percent = T,
      y.expand = c(0, .55),
      title = "Run Chart: % of Injured Patients with Effective Pain Management per Month",
      subtitle = "Fiscal Year: 2022",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


run_chart_trma_03_wk_p <- 
  qic(x = wk,
      y = treatment,
      n = n,
      notes = notes,
      data = run_chart_table_trma_03_wk,
      chart = "run",
      point.size = 2.5,
      x.format = "%b '%y",
      y.percent = T,
      y.expand = c(0, 0.5),
      title = "Run Chart: % of Injured Patients with Effective Pain Management per Week",
      subtitle = "Fiscal Year: 2022",
      xlab     = NULL) +
  theme_tufte() +
  theme(legend.position = 'none')


```

# Appendix

## Understanding Run Charts and Shewhart Charts

```{r spc expample, include=FALSE}
set.seed(7)
spc_vec_1 <- rnorm(20 ,mean = 10, sd = 2)

spc_vec_2 <- spc_vec_1

spc_vec_2[14] <- 22.56

p1_run <- 
  qic(spc_vec_1, chart = "run",
      title = "Run Chart Example",
      ylab  = "Value",
      xlab  = "Time", 
      y.expand = c(0,15),
      x.pad = 2, 
      point.size = 2.5) +
  theme_clean() +
  theme(legend.position = "none")

p1_i <- 
  qic(spc_vec_1, chart = "i",
      title = "Individuals Chart Example",
      ylab  = "Value",
      xlab  = "Time", 
      y.expand = c(0,15),
      x.pad = 2, 
      point.size = 2.5) +
  theme_clean() +
  theme(legend.position = "none")


p1_mr <- 
  qic(spc_vec_1, chart = "mr",
      title = "Moving Range Chart Example", 
      ylab  = "Value",
      xlab  = "Time", 
      y.expand = c(0,15),
      x.pad = 2, 
      point.size = 2.5) +
  theme_clean() +
  theme(legend.position = "none")



p2_run <- 
  qic(spc_vec_2, chart = "run",
      title = "Run Chart Example 2, Special Cause",
      ylab  = "Value",
      xlab  = "Time",
      y.expand = c(0, 25),
      x.pad = 2, 
      point.size = 2.5) +
  theme_clean() +
  theme(legend.position = "none")

p2_i <- 
  qic(spc_vec_2, chart = "i",
      title = "Individuals Chart Example 2, Special Cause",
      ylab  = "Value",
      xlab  = "Time",
      y.expand = c(0, 25),
      x.pad = 2, 
      point.size = 2.5) +
  theme_clean() +
  theme(legend.position = "none")


p2_mr <- 
  qic(spc_vec_2, chart = "mr",
      title = "Moving Range Chart Example 2, Special Cause",
      ylab  = "Value",
      xlab  = "Time",
      y.expand = c(0, 25),
      x.pad = 2, 
      point.size = 2.5)+
  theme_clean() +
  theme(legend.position = "none")

# Systematic shift

set.seed(11)
spc_sys_vec <- rnorm(20, mean = 10, sd = 1)

spc_sys_vec_shift <- spc_sys_vec

spc_sys_vec_shift[13:20] <- c(12.1, 14.8, 13.3, 15.0, 16.5, 14.4, 14.9, 13.9)


p3_run <-
  qic(spc_sys_vec_shift, chart = "run",
      y.expand = c(6, 20),
      title = "Run Chart with Systematic Shift",
      ylab  = "Value",
      xlab  = "Time",
      x.pad = 2, 
      point.size = 2.5) +
  theme_clean() +
  theme(legend.position = "none")


p3_run_freeze <-
  qic(spc_sys_vec_shift, chart = "run",
      freeze = 12,
      title = "Run Chart with Systematic Shift - Freezing Change Point",
      ylab  = "Value",
      xlab  = "Time",
      x.pad = 2,
      y.expand = c(6, 20), 
      point.size = 2.5) +
  theme_clean() +
  theme(legend.position = "none")


p3_run_part <-
  qic(spc_sys_vec_shift, chart = "run",
      part = 12,
      title = "Run Chart with Systematic Shift - Separating Change Point",
      ylab  = "Value",
      xlab  = "Time",
      x.pad = 2,
      y.expand = c(6, 20), 
      point.size = 2.5) +
  theme_clean() +
  theme(legend.position = "none")

```

Statistical Process Control Charts, also known as 'Shewhart Charts', are set of graphical depictions of how processes or systems performs by displaying valuable information about their inherent variation. Value is further amplified by the ability to detect shifts or anomalies within a process as well. Detecting these shifts has implications for understanding how applied changes, intended or unintended, affect outcomes (or lack thereof).

Variation in a process can be classified as two types: Common Cause Variation and Special Cause Variation. Common Cause Variation is variation that is inherent of the system. Examples 1.1-1.3 show the application of a Run Chart, Individuals Chart, and Moving Range Chart to describe what a stable process produces with common cause variation.

Special Cause Variation is variation that falls outside of the expected range or any data point that exceed 3 Standard Deviations from the mean (above or below).

## Common Cause Variation
The run chart in Ex. 1.1 shows the output of a random process, represented as the blue line. The center line (solid black line) denotes the median - and describes the 'middle' of the data. In this case, the median for this particular case is `r round(min(p1_run$data$cl), 1)`, with 50% of the data above the line, and 50% below the line. What we see here is a process with what appears to be normal variation.

### Ex. 1.1

```{r p1 run chart, echo=FALSE, fig.width=10}
p1_run

```


To confirm this, we can use two additional charts: Individuals and Moving Range. These charts help us determine if a process has issues with "Special Cause Variation"; or more succinctly - variation outside of the expected range. 


------------------------------------------------------------------------

### Ex. 1.2

```{r p1 i chart, echo=FALSE, fig.width=10}
p1_i

```

In this case, the individuals chart changes. We have 4 additional pieces of information: a gray area box, a new center line number, and two additional numbers above and below the center line. The gray area is the expected range of outputs from the system, with an **average** output of `r round(min(p1_i$data$cl), 1)` and upper and lower control limit of `r round(min(p1_i$data$lcl), 1)` and `r round(min(p1_i$data$lcl), 1)` respectively.

This chart confirms that our process is stable and in 'control'. It has some level of predictability. 


------------------------------------------------------------------------

### Ex. 1.3

```{r p1 moving range chart, echo=FALSE, fig.width=10}
p1_mr
```

Further confirmation of a stable process, in conjunction with the individuals chart is the moving range chart. This graph reveals how much the data moves from point to point; and is also an important component in calculating the control limits in the individuals chart. Our moving range chart reveals an average change of `r round(min(p1_mr$data$cl), 1)` units with an expected change in the range of `r round(min(p1_mr$data$lcl), 1)` and `r round(min(p1_mr$data$ucl), 1)` units.


## Special Cause Variation

At times, special cause variation can be difficult to detect. Example 2.1 reveals what may be an 'astronomical point' or point that is considered on the extreme end of what a process or system could produce. But because a run chart is designed to detect systematic shifts, it will not identify data outside the expected range. Hence, we use an Individuals Chart.

### Ex. 2.1

```{r p2 run special cause, echo=FALSE, fig.width=10}
p2_run
```

-----

The chart in Ex. 2.2 reveals a single data point outside the expected range of outputs from our process or system and is indeed a 'Special Cause' data point. The question becomes, what is to be done about this point?

### Ex. 2.2 

```{r p2 i special cause, echo=FALSE, fig.width=10}
p2_i
```

Special Cause variation requires some research as to the potential cause, which can lead to a determination on what the action (if any) should be to prevent future issues.

-----

Finally, we use the moving range, Ex. 2.3, to better understand how much the data are moving from point to point. In this special cause example, our data do not drastically change from point to point - even though we have a 'special cause' data point. 

### Ex. 2.3


```{r mr special cause, echo=FALSE, fig.width=10}
p2_mr
```

This may indicate a number of things about our process. First, it may indicate a gradual deviance away from our standard process output. For example, a manufacturing plant saw increasing numbers of employees taking sick days each day. The accumulated number of employees sick resulted in a higher than expected number out of work. The return to normal then where the employees returning from sick leave. 

## Systematic Shift

Finally, we come to understanding systematic shifts in process and system outputs. Often times we look for systematic changes when we know some external or internal system/process change has occurred. A salient real life example is the COVID-19 pandemic. During the initial months of the pandemic, much of the world was shut down and massive shifts in systems were apparent. 

Ex. 3.1 shows what a systematic shift may look like on a run chart. 

### Ex. 3.1

```{r run system shift, echo=FALSE, fig.width=10}

p3_run
```

Here we a dotted line which indicates a shift in the system. Visual inspection reveals an apparent increase later in time, starting around the 13th data point. We could reason this is the result of some intervention developed by an improvement team - essentially showing the impact of what they implemented.

Because we are interested in a systematic shift, our run chart will be sufficient. 

To understand what the difference of our pre-intervention to our post intervention, we "freeze" the median at point 12; therefore only calculating the data based on the initial 12 data points, Ex. 2.2.

### Ex. 3.2 

```{r run systeme shfit freeze, echo=FALSE, fig.width=10}

p3_run_freeze

```

Then finally,, once we have determined that a shift had indeed occurred - we 'reset' the data to the new norm. Ex. 3.3 


### Ex. 3.3

```{r run system shift part, echo=FALSE, fig.width=10}

p3_run_part
```

Here we see the median output move from `r round(min(p3_run_part$data$cl), 1)` to `r round(max(p3_run_part$data$cl), 1)`. However, context for this case must be taken into consideration. A change like this may not actually be an improvement, but negative effect of direct change or *indirect* change to other systems or processes. 
